<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Printable Tape</title>
  <link rel="stylesheet" href="print.css">
  <meta name="robots" content="noindex">
</head>
<body class="print-page">
  <main>
    <header>
      <button type="button" id="closePreview" class="close-preview">
        ← Close preview
      </button>
      <h1>Counter Tape</h1>
      <p id="generated"></p>
    </header>
    <section>
      <ul id="printTapeList"></ul>
    </section>
  </main>
  <template id="printTapeItem">
    <li>
      <time class="print-time"></time>
      <div class="print-body">
        <span class="print-label"></span>
        <span class="print-job"></span>
        <span class="print-seq"></span>
      </div>
      <span class="print-count"></span>
    </li>
  </template>
  <script>
    (function() {
      const STORAGE_KEYS = ['cc:v3', 'clicker-state'];
      let tape = [];
      for (const key of STORAGE_KEYS) {
        const stored = localStorage.getItem(key);
        if (!stored) continue;
        try {
          const parsed = JSON.parse(stored);
          tape = normalizeTapeEntries(parsed && parsed.tape);
          if (tape.length || key === 'cc:v3') {
            break;
          }
        } catch (error) {
          console.error('Unable to parse stored tape', error);
        }
      }
      const list = document.getElementById('printTapeList');
      const template = document.getElementById('printTapeItem');
      const generated = document.getElementById('generated');
      const closeButton = document.getElementById('closePreview');
      generated.textContent = tape.length ? `Generated ${new Date().toLocaleString()}` : 'No tape entries stored yet.';
      tape.forEach(entry => {
        const clone = template.content.firstElementChild.cloneNode(true);
        const timeEl = clone.querySelector('.print-time');
        const labelEl = clone.querySelector('.print-label');
        const jobEl = clone.querySelector('.print-job');
        const seqEl = clone.querySelector('.print-seq');
        const countEl = clone.querySelector('.print-count');
        const date = new Date(entry.ts);
        timeEl.dateTime = date.toISOString();
        timeEl.textContent = date.toLocaleString();
        labelEl.textContent = entry.label || '—';
        if (jobEl) {
          jobEl.textContent = entry.job || '';
          jobEl.hidden = !entry.job;
        }
        if (seqEl) {
          seqEl.textContent = entry.seqText || '';
          seqEl.hidden = !entry.seqText;
        }
        countEl.textContent = entry.count;
        list.appendChild(clone);
      });
      if (new URLSearchParams(location.search).get('auto') === '1' && tape.length) {
        window.addEventListener('load', () => setTimeout(() => window.print(), 100));
      }
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          if (window.opener && !window.opener.closed) {
            window.close();
          } else {
            window.location.href = './';
          }
        });
      }

      function normalizeTapeEntries(raw) {
        if (!Array.isArray(raw)) return [];
        return raw.map(entry => {
          if (!entry || typeof entry !== 'object') return null;
          const tsNumber = Number(entry.ts);
          let ts = Number.isFinite(tsNumber) ? tsNumber : Date.parse(entry.ts);
          if (!Number.isFinite(ts)) {
            ts = Date.now();
          }
          const seqValue = entry.seq == null ? null : Number(entry.seq);
          const seq = Number.isFinite(seqValue) ? Math.floor(seqValue) : null;
          let seqMode = typeof entry.seqMode === 'string' ? entry.seqMode : (seq != null ? 'simple' : 'none');
          if (!['none', 'simple', 'custom'].includes(seqMode)) {
            seqMode = seq != null ? 'simple' : 'none';
          }
          let seqText = typeof entry.seqText === 'string' ? entry.seqText : '';
          if (seq != null && !seqText) {
            if (seqMode === 'custom' && typeof entry.seqTitleCustom === 'string' && entry.seqTitleCustom.trim()) {
              seqText = `${entry.seqTitleCustom.trim()} #${seq}`;
            } else {
              seqText = `#${seq}`;
            }
          }
          if (seq == null) {
            seqMode = 'none';
            seqText = '';
          }
          return {
            id: typeof entry.id === 'string' ? entry.id : `${ts}-${Math.random().toString(16).slice(2)}`,
            ts,
            label: typeof entry.label === 'string' ? entry.label : '',
            job: typeof entry.job === 'string' ? entry.job : '',
            seq,
            seqMode,
            seqText,
            count: Number(entry.count) || 0
          };
        }).filter(Boolean);
      }
    })();
  </script>
</body>
</html>
